<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Easyë°˜ - í•™ê¸‰ ë„êµ¬</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0f172a;
      --muted: #64748b;
      --card: #f8fafc;
      --accent: #2563eb;
      --accent-2: #10b981;
      --border: #e2e8f0;
    }
    .dark {
      --bg: #0b1220;
      --fg: #e5e7eb;
      --muted: #9aa4b2;
      --card: #0f172a;
      --accent: #60a5fa;
      --accent-2: #34d399;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, sans-serif;
      background: var(--bg); color: var(--fg);
    }
    header { position: sticky; top: 0; z-index: 10; background: var(--bg); border-bottom: 1px solid var(--border); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    h1 { margin: 0; font-size: 22px; }
    .spacer { flex: 1; }
    button, select, input, textarea { color: var(--fg); background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; }
    button { cursor: pointer; transition: transform .02s ease-in-out; }
    button:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: white; border-color: transparent; }
    .btn-success { background: var(--accent-2); color: white; border-color: transparent; }
    .tabs { display: flex; gap: 8px; padding: 12px 0; flex-wrap: wrap; }
    .tab { padding: 10px 14px; border: 1px solid var(--border); background: var(--card); border-radius: 999px; cursor: pointer; }
    .tab.active { background: var(--accent); color: white; border-color: transparent; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .grid { display: grid; gap: 8px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    /* ìë¦¬í‘œ */
    .seat-grid { display: grid; gap: 8px; }
    .seat { background: white; color: #0f172a; border-radius: 10px; padding: 10px; border: 1px solid var(--border); text-align: center; font-weight: 600; }
    .dark .seat { background: #111827; color: #e5e7eb; }

    /* ì†ŒìŒê³„ */
    .meter { height: 18px; background: #111827; border-radius: 999px; overflow: hidden; position: relative; }
    .meter-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444); transition: width .1s linear; }
    .meter-label { font-variant-numeric: tabular-nums; }

    /* ì•Œë¦¼ì¥ */
    textarea { width: 100%; min-height: 120px; resize: vertical; }
    .notice-preview { white-space: pre-wrap; border-left: 4px solid var(--accent); padding-left: 12px; background: rgba(0,0,0,0.02); border-radius: 8px; }
    .dark .notice-preview { background: rgba(255,255,255,0.04); }

    /* ë¦¬ì•¡ì…˜ */
    .reaction { position: fixed; pointer-events: none; font-size: var(--rx-size, 28px); line-height: 1; animation: rise 900ms ease-out forwards; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); }
    @keyframes rise { from { transform: translate(-50%, 0) scale(.9); opacity: 0; } 40% { opacity: 1; } to { transform: translate(-50%, -120px) scale(1.2); opacity: 0; } }

    /* ì ìˆ˜íŒ */
    .score-wrap { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
    .score-card { display:grid; place-items:center; padding:16px; border:1px solid var(--border); border-radius:16px; background:var(--card); user-select:none; }
    .score-title { font-weight:700; margin-bottom:8px; cursor:pointer; }
    .score-value { font-size: clamp(48px, 12vw, 120px); font-weight: 800; line-height:1; }
    .score-hint { color: var(--muted); font-size: 12px; margin-top: 6px; }

    footer { text-align: center; color: var(--muted); padding: 24px; }
      
    /* === íŒì—…(í™•ëŒ€ ë³´ê¸°) === */
    .modal{position:fixed; inset:0; display:grid; place-items:center; z-index:1000;}
    .modal[hidden]{display:none;}
    .modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter:saturate(120%) blur(1px);}
    .modal-content{position:relative; background:var(--bg); color:var(--fg); border:1px solid var(--border); border-radius:16px; padding:16px; width:min(92vw,800px); box-shadow:0 10px 30px rgba(0,0,0,.3);}
    .big-time{font-variant-numeric:tabular-nums; text-align:center; font-weight:800; line-height:1; padding:16px; font-size:clamp(48px, 16vw, 180px);}
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <h1>Easyë°˜ Â· í•™ê¸‰ ë„êµ¬</h1>
      <div class="spacer"></div>
      <button id="darkToggle" aria-pressed="false" title="ë‹¤í¬ëª¨ë“œ í† ê¸€">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
      <button id="saveAll" class="btn-success" title="ì…ë ¥ê°’ ì €ì¥">ì €ì¥</button>
    </div>
  </header>

  <main class="container">
    <nav class="tabs" role="tablist" aria-label="ê¸°ëŠ¥ íƒ­">
      <button class="tab active" data-tab="seating" role="tab" aria-selected="true">ìë¦¬ ë°”ê¾¸ê¸°</button>
      <button class="tab" data-tab="election" role="tab" aria-selected="false">í•™ê¸‰ ì„ ê±°(ë¹„ë°€íˆ¬í‘œ)</button>
      <button class="tab" data-tab="noise" role="tab" aria-selected="false">ì†ŒìŒ ì¸¡ì •ê¸°</button>
      <button class="tab" data-tab="notice" role="tab" aria-selected="false">ì•Œë¦¼ì¥</button>
      <button class="tab" data-tab="score" role="tab" aria-selected="false">ì ìˆ˜íŒ</button>
      <button class="tab" data-tab="timer" role="tab" aria-selected="false">íƒ€ì´ë¨¸/ìŠ¤í†±ì›Œì¹˜</button>
    </nav>

    <!-- ìë¦¬ ë°”ê¾¸ê¸° -->
    <section id="seating" class="card" role="tabpanel">
      <div class="grid grid-2" style="gap:16px;">
        <div>
          <label>í•™ìƒ ëª…ë‹¨ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
          <textarea id="studentList" placeholder="ì˜ˆ)í™ê¸¸ë™\nì„êº½ì •\nì´ìˆœì‹ "></textarea>
          <div class="row" style="margin-top:8px; gap:8px; align-items: center;">
            <label for="cols">ê°€ë¡œ ì¹¸</label>
            <input id="cols" type="number" min="2" max="10" value="4" style="width:90px;">
            <label for="rows">ì„¸ë¡œ ì¤„</label>
            <input id="rows" type="number" min="2" max="10" value="5" style="width:90px;">
            <button id="shuffleSeats" class="btn-primary">ìë¦¬ ì„ê¸°</button>
            <button id="clearSeats">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div>
          <div class="row" style="justify-content: space-between; align-items:center;">
            <strong>ìë¦¬í‘œ</strong>
            <small id="seatCount" class="muted"></small>
          </div>
          <div id="seatGrid" class="seat-grid" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- í•™ê¸‰ ì„ ê±° -->
    <section id="election" class="card" role="tabpanel" hidden>
      <div class="grid grid-2" style="gap:16px;">
        <div>
          <label>í›„ë³´ì ëª…ë‹¨ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
          <textarea id="candidates" placeholder="ì˜ˆ)í™ê¸¸ë™\nì„êº½ì •\nì´ìˆœì‹ "></textarea>
          <div class="row" style="margin-top:8px; gap:8px; flex-wrap:wrap;">
            <div class="row" style="gap:8px; align-items:center;">
              <label for="requiredVotes">íˆ¬í‘œ ì¸ì›</label>
              <input id="requiredVotes" type="number" min="1" placeholder="ì˜ˆ: 25" style="width:100px;">
            </div>
            <button id="startVote" class="btn-primary">íˆ¬í‘œ ì‹œì‘</button>
            <button id="endVote">íˆ¬í‘œ ë§ˆê° ë° ê°œí‘œ</button>
            <button id="resetVote">ì´ˆê¸°í™”</button>
          </div>
          <p class="muted">* ìˆ«ìí‚¤ <strong>1â€“9</strong>ë¡œ <strong>ë¹ ë¥¸ íˆ¬í‘œ</strong> ê°€ëŠ¥</p>
        </div>
        <div>
          <div class="row" style="gap:8px; align-items:center;">
            <strong>íˆ¬í‘œ í™”ë©´</strong>
            <span id="voteStatus" class="muted">ëŒ€ê¸° ì¤‘</span>
          </div>
          <div id="ballot" class="grid grid-2" style="margin-top:8px;"></div>
          <div id="results" style="margin-top:12px;"></div>
        </div>
      </div>
    </section>

    <!-- ì†ŒìŒ ì¸¡ì •ê¸° -->
    <section id="noise" class="card" role="tabpanel" hidden>
      <div class="row" style="gap:8px; align-items:center;">
        <button id="startNoise" class="btn-primary">ì¸¡ì • ì‹œì‘</button>
        <button id="stopNoise">ì •ì§€</button>
        <span class="meter-label" id="dbLabel">ëŒ€ê¸° ì¤‘</span>
      </div>
      <div class="meter" style="margin-top:10px;">
        <div class="meter-fill" id="meterFill"></div>
      </div>
      <p class="muted" style="margin-top:8px;">* ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ìƒëŒ€ì ì¸ ì†ŒìŒ ì§€í‘œì´ë©° ì‹¤ì œ ë°ì‹œë²¨ê³¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </section>

    <!-- ì•Œë¦¼ì¥ -->
    <section id="notice" class="card" role="tabpanel" hidden>
      <div class="grid grid-2" style="gap:16px;">
        <div>
          <label for="noticeDate">ë‚ ì§œ</label>
          <input id="noticeDate" type="date" />
          <label style="margin-top:8px; display:block;">ì•Œë¦¼ì¥ ë‚´ìš©</label>
          <textarea id="noticeText" placeholder="í•­ëª©ì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”"></textarea>
          <div class="row" style="margin-top:8px; gap:8px;">
            <button id="previewNotice" class="btn-primary">ë¯¸ë¦¬ë³´ê¸°</button>
            <button id="downloadNotice">TXTë¡œ ì €ì¥</button>
            <button id="clearNotice">ì§€ìš°ê¸°</button>
          </div>
        </div>
        <div>
          <strong>ë¯¸ë¦¬ë³´ê¸°</strong>
          <div id="noticePreview" class="notice-preview" style="margin-top:8px;">ì•„ì§ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    </section>

    <!-- ì ìˆ˜íŒ -->
    <section id="score" class="card" role="tabpanel" hidden>
      <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button id="scoreAdd" class="btn-primary">íŒ€ ì¶”ê°€</button>
        <button id="scoreRemove">íŒ€ ì‚­ì œ</button>
        <button id="scoreReset">ì ìˆ˜ ì´ˆê¸°í™”</button>
      </div>
      <div id="scoreWrap" class="score-wrap" aria-live="polite"></div>
      <div id="teamEditor" class="grid" style="gap:8px; margin-top:12px;"></div>
      <p class="score-hint">ë§ˆìš°ìŠ¤ <strong>ì¢Œí´ë¦­</strong> â†’ +1, <strong>ìš°í´ë¦­</strong> â†’ -1 (ìš°í´ë¦­ ë©”ë‰´ëŠ” ìë™ìœ¼ë¡œ ë§‰ìŠµë‹ˆë‹¤)</p>
    </section>

    <!-- íƒ€ì´ë¨¸/ìŠ¤í†±ì›Œì¹˜ -->
    <section id="timer" class="card" role="tabpanel" hidden>
      <div class="grid" style="gap:12px;">
        <div class="card" style="padding:12px;">
          <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
            <strong>íƒ€ì´ë¨¸</strong>
            <input id="timerInput" placeholder="ì˜ˆ: 10:00 ë˜ëŠ” 600" style="width:160px;" />
            <button id="timerSet">ì‹œê°„ ì„¤ì •</button>
            <button id="timerStartPause" class="btn-primary">ì‹œì‘</button>
            <button id="timerReset">ë¦¬ì…‹</button>
            <span id="timerDisplay" style="font-weight:800; font-variant-numeric:tabular-nums; margin-left:8px;">00:00</span>
            <button id="timerZoom" title="íƒ€ì´ë¨¸ í¬ê²Œ ë³´ê¸°">ğŸ” í™•ëŒ€</button>
          </div>
        </div>
        <div class="card" style="padding:12px;">
          <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
            <strong>ìŠ¤í†±ì›Œì¹˜</strong>
            <button id="swStartStop" class="btn-primary">ì‹œì‘</button>
            <button id="swLap">ë©</button>
            <button id="swReset">ë¦¬ì…‹</button>
            <span id="swDisplay" style="font-weight:800; font-variant-numeric:tabular-nums; margin-left:8px;">00:00.0</span>
            <button id="swZoom" title="ìŠ¤í†±ì›Œì¹˜ í¬ê²Œ ë³´ê¸°">ğŸ” í™•ëŒ€</button>
          </div>
          <div id="swLaps" class="grid" style="margin-top:8px; gap:6px;"></div>
        </div>
      </div>
    </section>
  

    <!-- í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="timeModal" class="modal" role="dialog" aria-modal="true" hidden>
      <div class="modal-backdrop" id="timeModalBackdrop"></div>
      <div class="modal-content">
        <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
          <strong id="timeModalTitle">í™•ëŒ€ ë³´ê¸°</strong>
          <button id="timeModalClose" aria-label="ë‹«ê¸°">ë‹«ê¸°</button>
        </div>
        <div id="timeModalDisplay" class="big-time">00:00</div>
      </div>
    </div>
  </main>

  <footer>Â© <span id="year"></span> Easyë°˜ â€” êµì‹¤ì—ì„œ ë°”ë¡œ ì“°ëŠ” ê°€ë²¼ìš´ ì›¹ë„êµ¬</footer>

  <script>
    // ìœ í‹¸
    const $ = (sel, parent=document) => parent.querySelector(sel);
    const $$ = (sel, parent=document) => Array.from(parent.querySelectorAll(sel));

    // ìƒíƒœ
    const state = { 
      dark:false, 
      voting:false, 
      votes:{}, 
      requiredVotes:0, 
      audio:{ ctx:null, analyser:null, raf:0, stream:null },
      score:[{name:'AíŒ€', score:0},{name:'BíŒ€', score:0}],
      // íƒ€ì´ë¨¸ & ìŠ¤í†±ì›Œì¹˜
      tmr:{ running:false, initial:0, remaining:0, interval:0 },
      sw:{ running:false, startMs:0, elapsedMs:0, interval:0, laps:[] }
    };

    // í…Œë§ˆ
    function applyTheme(dark){
      document.documentElement.classList.toggle('dark', dark);
      const btn=$('#darkToggle'); if(btn){ btn.setAttribute('aria-pressed', String(dark)); btn.textContent = dark ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ'; }
      try{ localStorage.setItem('easyban:dark', dark?'1':'0'); }catch(e){}
    }

    // íƒ­
    function activateTab(id){
      $$('.tab').forEach(t=>{ const active=t.dataset.tab===id; t.classList.toggle('active',active); t.setAttribute('aria-selected', String(active)); });
      ['seating','election','noise','notice','score','timer'].forEach(sec=>{ const el=document.getElementById(sec); if(el) el.hidden = sec!==id; });
    }

    // ìë¦¬ ì„ê¸°
    function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function renderSeats(){
      const names=$('#studentList').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const cols=Math.max(2, Math.min(10, parseInt($('#cols').value||'4',10)));
      const rows=Math.max(2, Math.min(10, parseInt($('#rows').value||'5',10)));
      const grid=$('#seatGrid'); grid.style.gridTemplateColumns=`repeat(${cols}, minmax(0,1fr))`; grid.innerHTML='';
      const total=cols*rows; const filled=shuffle(names).slice(0,total);
      for(let i=0;i<total;i++){ const div=document.createElement('div'); div.className='seat'; div.textContent=filled[i]||''; grid.appendChild(div); }
      $('#seatCount').textContent = `ì¢Œì„ ${total}ê°œ / í•™ìƒ ${names.length}ëª…`;
    }

    // ì„ ê±°
    function parseCandidates(){ return $('#candidates').value.split(/\n+/).map(s=>s.trim()).filter(Boolean); }
    function totalVotes(){ return Object.values(state.votes).reduce((a,b)=>a+b,0); }
    function updateVoteStatus(){ const t=totalVotes(); const need=state.requiredVotes||0; $('#voteStatus').textContent = state.voting ? (need>0?`ì§„í–‰ ì¤‘(ë¹„ë°€íˆ¬í‘œ) Â· ${t}/${need}`:`ì§„í–‰ ì¤‘(ë¹„ë°€íˆ¬í‘œ) Â· ${t}í‘œ`) : 'ë§ˆê°'; }
    function renderResults(hide){ const box=$('#results'); if(hide&&state.voting){ box.innerHTML='<em class="muted">ì§„í–‰ ì¤‘: ê°œí‘œ ê²°ê³¼ëŠ” ìˆ¨ê¹€</em>'; return; } const entries=Object.entries(state.votes); if(!entries.length){ box.textContent='ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'; return; } entries.sort((a,b)=>b[1]-a[1]); const tot=totalVotes()||1; box.innerHTML = '<pre>' + entries.map(([n,v])=>`${n}: ${v}í‘œ (${Math.round(v/tot*100)}%)`).join('\n') + '</pre>'; }
    function renderBallot(hide){ const ballot=$('#ballot'); ballot.innerHTML=''; const cand=parseCandidates(); if(!cand.length){ state.votes={}; $('#results').innerHTML='<em class="muted">í›„ë³´ì ëª…ë‹¨ì„ ì…ë ¥í•˜ë©´ íˆ¬í‘œë¥¼ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”.</em>'; updateVoteStatus(); return; } cand.forEach(c=>{ if(!(c in state.votes)) state.votes[c]=0; const btn=document.createElement('button'); btn.className='btn-primary'; btn.textContent=c + (state.voting?' Â· íˆ¬í‘œ':''); btn.disabled=!state.voting; btn.addEventListener('click',()=>{ if(!state.voting) return; state.votes[c]++; renderResults(hide); maybeEndVoting(); }); ballot.appendChild(btn); }); renderResults(hide); updateVoteStatus(); }
    function endVoting(reason){ state.voting=false; renderResults(false); updateVoteStatus(); if(reason){ const prev=$('#results').innerHTML; $('#results').innerHTML = `<div class="muted">${reason}</div>` + prev; } }
    function maybeEndVoting(){ const need=state.requiredVotes||0; if(state.voting && need>0 && totalVotes()>=need){ endVoting('ìë™ ë§ˆê°: ì„¤ì •í•œ ì¸ì› ìˆ˜ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.'); } else { updateVoteStatus(); } }
    function resetVote(){ state.votes={}; state.voting=false; $('#voteStatus').textContent='ëŒ€ê¸° ì¤‘'; renderBallot(true); }

    // ë¦¬ì•¡ì…˜ (íˆ¬í‘œ ì¤‘ ë¹„í™œì„±)
    function reactAt(x,y,emoji='ğŸ‰',size='50vmin'){ const el=document.createElement('div'); el.className='reaction'; el.textContent=emoji; el.style.left=x+'px'; el.style.top=y+'px'; el.style.position='fixed'; el.style.setProperty('--rx-size', size); document.body.appendChild(el); setTimeout(()=>el.remove(),1000); }
    window.addEventListener('keydown', (e)=>{
      const tag=(e.target&&e.target.tagName)?e.target.tagName.toLowerCase():''; if(tag==='input'||tag==='textarea'||e.isComposing) return; const activeTab=document.querySelector('.tab.active')?.dataset.tab;
      const map={ q:'ğŸ‘', w:'ğŸ‘', e:'ğŸ‰', r:'â­', t:'ğŸ¤«' };
      const k=e.key.toLowerCase();
      if(map[k]){ if(!(activeTab==='election' && state.voting)){ const x=(innerWidth/2)+(Math.random()*120-60); const y=(innerHeight/2)+(Math.random()*80-40); reactAt(x, y, map[k]); } }
      if(activeTab==='election' && state.voting && /^[1-9]$/.test(e.key)){ const idx=parseInt(e.key,10)-1; const buttons=$$('#ballot button'); if(idx<buttons.length){ const label=buttons[idx].textContent.replace(/\s*Â·\s*íˆ¬í‘œ$/, ''); const candName=parseCandidates().find(c=>label.startsWith(c))||parseCandidates()[idx]; if(candName){ state.votes[candName]=(state.votes[candName]||0)+1; renderResults(true); maybeEndVoting(); } }
      }
    });

    // ì†ŒìŒê³„
    async function startNoise(){ if(state.audio.ctx) return; const ctx=new (window.AudioContext||window.webkitAudioContext)(); const stream=await navigator.mediaDevices.getUserMedia({audio:true}); const source=ctx.createMediaStreamSource(stream); const analyser=ctx.createAnalyser(); analyser.fftSize=2048; source.connect(analyser); state.audio={ctx,analyser,stream,raf:0}; loopNoise(); $('#dbLabel').textContent='ì¸¡ì • ì¤‘â€¦'; }
    function stopNoise(){ if(!state.audio.ctx) return; cancelAnimationFrame(state.audio.raf); state.audio.ctx.close(); state.audio.stream.getTracks().forEach(t=>t.stop()); state.audio = { ctx:null, analyser:null, stream:null, raf:0 }; $('#meterFill').style.width='0%'; $('#dbLabel').textContent='ëŒ€ê¸° ì¤‘'; }
    function loopNoise(){ const {analyser}=state.audio; const data=new Uint8Array(analyser.fftSize); const update=()=>{ analyser.getByteTimeDomainData(data); let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; } const rms=Math.sqrt(sum/data.length); const db=20*Math.log10(rms+1e-6)+60; const pct=Math.max(0, Math.min(100, (db/60)*100)); $('#meterFill').style.width=pct.toFixed(1)+'%'; $('#dbLabel').textContent=`ì†ŒìŒ ì§€í‘œ: ${db.toFixed(1)} dB*`; state.audio.raf=requestAnimationFrame(update); }; update(); }

    // === í™•ëŒ€ ëª¨ë‹¬ ===
    let timeModalMode = null; // 'timer' | 'sw' | null
    function openTimeModal(mode){
      timeModalMode = mode;
      const modal = document.getElementById('timeModal');
      const title = document.getElementById('timeModalTitle');
      title.textContent = mode==='timer' ? 'íƒ€ì´ë¨¸' : 'ìŠ¤í†±ì›Œì¹˜';
      updateTimeModal();
      modal.hidden = false;
      document.addEventListener('keydown', escCloser);
    }
    function closeTimeModal(){
      const modal = document.getElementById('timeModal');
      modal.hidden = true;
      timeModalMode = null;
      document.removeEventListener('keydown', escCloser);
    }
    function escCloser(e){ if(e.key==='Escape') closeTimeModal(); }
    function updateTimeModal(){
      const disp = document.getElementById('timeModalDisplay');
      if(!disp || document.getElementById('timeModal').hidden) return;
      if(timeModalMode==='timer'){ disp.textContent = formatTime(state.tmr.remaining); }
      else if(timeModalMode==='sw'){ disp.textContent = formatMs(state.sw.elapsedMs); }
    }

    // ì•Œë¦¼ì¥
    function previewNotice(){ const date=$('#noticeDate').value||new Date().toISOString().slice(0,10); const lines=$('#noticeText').value.split(/\n+/).map(s=>s.trim()).filter(Boolean); const text=[[`[ì•Œë¦¼ì¥] ${date}`,''].concat(lines.map(t=>`â€¢ ${t}`)).join('\n')].join(''); $('#noticePreview').textContent=text||'ì•„ì§ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'; return text; }
    function downloadNotice(){ const text=previewNotice(); const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ì•Œë¦¼ì¥_${new Date().toISOString().slice(0,10)}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    // ìœ íŠœë¸Œ íŒŒì‹±(í…ŒìŠ¤íŠ¸ìš©)
    function parseTimeToSeconds(t){ if(!t) return 0; if(/^\d+$/.test(t)) return parseInt(t,10); const m=String(t).match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i); if(!m) return 0; const h=parseInt(m[1]||'0',10), mi=parseInt(m[2]||'0',10), s=parseInt(m[3]||'0',10); return h*3600+mi*60+s; }
    function extractYouTubeId(url){ try{ const u=new URL(url); const host=u.hostname.replace(/^www\./,''); if(host==='youtu.be'){ return u.pathname.slice(1); } if(host==='youtube.com'||host==='m.youtube.com'||host==='youtube-nocookie.com'){ if(u.pathname.startsWith('/watch')) return u.searchParams.get('v'); if(u.pathname.startsWith('/shorts/')) return u.pathname.split('/')[2]; if(u.pathname.startsWith('/embed/')) return u.pathname.split('/')[2]; } return null; }catch(e){ return null; } }
    function buildEmbedUrl(inputUrl){ const u=new URL(inputUrl); const id=extractYouTubeId(inputUrl); if(!id) return null; const start=parseTimeToSeconds(u.searchParams.get('t')||u.searchParams.get('start')); const params=new URLSearchParams({rel:'0', modestbranding:'1'}); if(start>0) params.set('start', String(start)); return `https://www.youtube.com/embed/${encodeURIComponent(id)}?${params.toString()}`; }

    // ì ìˆ˜íŒ
    function renderScoreboard(){
      const wrap = $('#scoreWrap');
      if (!wrap) return;
      wrap.innerHTML = '';
      state.score.forEach((team, idx) => {
        const card = document.createElement('div');
        card.className = 'score-card';
        card.setAttribute('data-idx', idx);
        card.innerHTML = `<div class=\"score-title\" title=\"ì´ë¦„ì„ í´ë¦­í•˜ë©´ ë³€ê²½í•©ë‹ˆë‹¤\">${team.name}</div><div class=\"score-value\">${team.score}</div>`;
        card.querySelector('.score-title').addEventListener('click', () => {
          const next = prompt('íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', team.name);
          if (next !== null) { team.name = (next.trim() || defaultTeamName(idx)); updateScoreCard(card, team); saveSilently(); renderTeamEditor(); }
        });
        card.addEventListener('click', (e) => { if (e.button!==0) return; team.score += 1; updateScoreCard(card, team); });
        card.addEventListener('contextmenu', (e) => { e.preventDefault(); team.score = Math.max(0, team.score - 1); updateScoreCard(card, team); });
        wrap.appendChild(card);
      });
    }
    function updateScoreCard(card, team){ card.querySelector('.score-title').textContent = team.name; card.querySelector('.score-value').textContent = team.score; }
    function defaultTeamName(i){
      const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let n=i, name='';
      do { name = letters[n%26] + name; n = Math.floor(n/26) - 1; } while(n>=0);
      return name + 'íŒ€';
    }
    function addTeam(){ state.score.push({ name: defaultTeamName(state.score.length), score: 0 }); renderScoreboard(); renderTeamEditor(); }
    function removeTeam(){ if (state.score.length <= 2) { alert('ìµœì†Œ 2íŒ€ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.'); return; } state.score.pop(); renderScoreboard(); renderTeamEditor(); }
    function removeTeamAt(idx){ if (state.score.length <= 2) { alert('ìµœì†Œ 2íŒ€ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.'); return; } state.score.splice(idx,1); renderScoreboard(); renderTeamEditor(); }
    function saveSilently(){ try{ const d = JSON.parse(localStorage.getItem('easyban:data')||'{}'); d.score = state.score; localStorage.setItem('easyban:data', JSON.stringify(d)); }catch(e){} }
    function normalizeScore(){
      if (!Array.isArray(state.score)) state.score = [];
      while(state.score.length < 2){
        const i = state.score.length;
        state.score.push({ name: defaultTeamName(i), score: 0 });
      }
      state.score = state.score.map((t,i)=>({
        name: (t && typeof t.name==='string' && t.name.trim()) ? t.name : defaultTeamName(i),
        score: Math.max(0, Number.isFinite(Number(t && t.score)) ? Number(t.score) : 0)
      }));
    }
    function renderTeamEditor(){
      const wrap = document.getElementById('teamEditor');
      if (!wrap) return;
      wrap.innerHTML = '';
      state.score.forEach((team, idx)=>{
        const row = document.createElement('div');
        row.className = 'row';
        row.style.gap = '8px';
        row.innerHTML = `
          <input type=\"text\" data-idx=\"${idx}\" value=\"${team.name}\" style=\"flex:1; min-width:140px;\" />
          <button data-del=\"${idx}\">ì‚­ì œ</button>
        `;
        const input = row.querySelector('input');
        input.addEventListener('input', (e)=>{ const v = e.target.value.trim(); state.score[idx].name = v || defaultTeamName(idx); renderScoreboard(); saveSilently(); });
        const delBtn = row.querySelector('button');
        delBtn.addEventListener('click', ()=> removeTeamAt(idx));
        wrap.appendChild(row);
      });
    }

    // íƒ€ì´ë¨¸/ìŠ¤í†±ì›Œì¹˜ ìœ í‹¸/ë¡œì§
    function parseHMS(input){
      if(input==null) return 0; var s=String(input).trim(); if(!s) return 0;
      if(/^\d+$/.test(s)) return parseInt(s,10);
      var parts=s.split(':').map(Number);
      if(parts.some(function(n){return Number.isNaN(n);} )) return 0;
      if(parts.length===2){ var m=parts[0], sec=parts[1]; return m*60+sec; }
      if(parts.length===3){ var h=parts[0], m2=parts[1], s2=parts[2]; return h*3600+m2*60+s2; }
      return 0;
    }
    function formatTime(total){ total=Math.max(0, Math.floor(total)); var h=Math.floor(total/3600); var m=Math.floor((total%3600)/60); var s=total%60; var pad=function(n){ n=String(n); return n.length<2?('0'+n):n; }; return h>0?(pad(h)+':'+pad(m)+':'+pad(s)):(pad(m)+':'+pad(s)); }
    function formatMs(ms){ ms=Math.max(0, ms|0); var total=Math.floor(ms/1000); var frac=Math.floor((ms%1000)/100); return formatTime(total)+'.'+frac; }

    function renderTimerUI(){ var el=$('#timerDisplay'); if(el) el.textContent = formatTime(state.tmr.remaining); var b=$('#timerStartPause'); if(b) b.textContent = state.tmr.running?'ì¼ì‹œì •ì§€':'ì‹œì‘'; updateTimeModal(); }
    function setTimerFromInput(){ var inp=$('#timerInput'); var v=inp?inp.value:''; var sec=parseHMS(v); state.tmr.initial=sec; state.tmr.remaining=sec; renderTimerUI(); }
    function timerTick(){ if(!state.tmr.running) return; state.tmr.remaining=Math.max(0, state.tmr.remaining-1); renderTimerUI(); if(state.tmr.remaining===0){ pauseTimer(); } }
    function startTimer(){ if(state.tmr.running) return; if(state.tmr.remaining<=0){ if(state.tmr.initial>0){ state.tmr.remaining=state.tmr.initial; } else { setTimerFromInput(); } }
      state.tmr.running=true; renderTimerUI(); clearInterval(state.tmr.interval); state.tmr.interval=setInterval(timerTick,1000); }
    function pauseTimer(){ if(!state.tmr.running) return; state.tmr.running=false; renderTimerUI(); clearInterval(state.tmr.interval); }
    function resetTimer(){ state.tmr.running=false; clearInterval(state.tmr.interval); state.tmr.remaining=state.tmr.initial; renderTimerUI(); }

    function renderStopwatch(){ var d=$('#swDisplay'); if(d) d.textContent = formatMs(state.sw.elapsedMs); var s=$('#swStartStop'); if(s) s.textContent = state.sw.running?'ì •ì§€':'ì‹œì‘'; var laps=$('#swLaps'); if(laps){ laps.innerHTML= state.sw.laps.map(function(ms,i){ return '#'+(i+1)+' â€” '+formatMs(ms); }).join(''); } updateTimeModal(); }
    function swTick(){ if(!state.sw.running) return; var now=Date.now(); state.sw.elapsedMs += (now - state.sw.startMs); state.sw.startMs=now; renderStopwatch(); }
    function startStopwatch(){ if(state.sw.running) return; state.sw.running=true; state.sw.startMs=Date.now(); clearInterval(state.sw.interval); state.sw.interval=setInterval(swTick,100); renderStopwatch(); }
    function stopStopwatch(){ if(!state.sw.running) return; swTick(); state.sw.running=false; clearInterval(state.sw.interval); renderStopwatch(); }
    function resetStopwatch(){ state.sw.running=false; clearInterval(state.sw.interval); state.sw.elapsedMs=0; state.sw.laps=[]; renderStopwatch(); }
    function lapStopwatch(){ if(!state.sw.running) return; swTick(); state.sw.laps.push(state.sw.elapsedMs); renderStopwatch(); }

    // ì €ì¥/ë¡œë“œ
    function saveAll(){ 
      const payload={ 
        students:$('#studentList').value, cols:$('#cols').value, rows:$('#rows').value,
        candidates:$('#candidates').value, requiredVotes:$('#requiredVotes').value,
        noticeDate:$('#noticeDate').value, noticeText:$('#noticeText').value,
        ytUrl:$('#ytUrl')?$('#ytUrl').value:'', dark:document.documentElement.classList.contains('dark'),
        score: state.score
      }; 
      try{ localStorage.setItem('easyban:data', JSON.stringify(payload)); }catch(e){} 
      alert('ì €ì¥ ì™„ë£Œ! (ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤)'); 
    }
    function loadAll(){ 
      try{ 
        const raw=localStorage.getItem('easyban:data');
        if(!raw){
          state.score=[{name:'AíŒ€',score:0},{name:'BíŒ€',score:0}];
          return;
        }
        const d=JSON.parse(raw);
        if(d.students) $('#studentList').value=d.students; if(d.cols) $('#cols').value=d.cols; if(d.rows) $('#rows').value=d.rows;
        if(d.candidates) $('#candidates').value=d.candidates; if(d.requiredVotes) $('#requiredVotes').value=d.requiredVotes;
        if(d.noticeDate) $('#noticeDate').value=d.noticeDate; if(d.noticeText) $('#noticeText').value=d.noticeText;
        if(d.ytUrl && $('#ytUrl')) $('#ytUrl').value=d.ytUrl; applyTheme(!!d.dark);
        if(Array.isArray(d.score) && d.score.length){ state.score = d.score; }
      }catch(e){}
    }

    // ===== ìë™ í…ŒìŠ¤íŠ¸ ì¼ë¶€ (ì ìˆ˜íŒ í•µì‹¬ TC) =====
    function runDevTests(){ try{
      console.group('[Easyë°˜] ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘');
      const prev={ votes:{...state.votes}, voting:state.voting, requiredVotes:state.requiredVotes, candidates:$('#candidates').value, students:$('#studentList').value, cols:$('#cols').value, rows:$('#rows').value, ytUrl:$('#ytUrl')?$('#ytUrl').value:'', score: JSON.parse(JSON.stringify(state.score)) };
      activateTab('score');
      state.score=[{name:'ĞíŒ€',score:0},{name:'BíŒ€',score:0}]; renderScoreboard(); renderTeamEditor();
      console.assert(state.score[0].name==='ĞíŒ€' && state.score[1].name==='BíŒ€','TC17 ì‹¤íŒ¨: ê¸°ë³¸ ì´ë¦„ AíŒ€/BíŒ€');
      const cards=$$('#scoreWrap .score-card');
      cards[0].dispatchEvent(new MouseEvent('click', {bubbles:true}));
      console.assert(state.score[0].score===1,'TC15 ì‹¤íŒ¨: ì¢Œí´ë¦­ +1');
      cards[0].dispatchEvent(new MouseEvent('contextmenu', {bubbles:true}));
      console.assert(state.score[0].score===0,'TC16 ì‹¤íŒ¨: ìš°í´ë¦­ -1, 0 ì•„ë˜ë¡œëŠ” ê°ì†Œ ê¸ˆì§€');
      // ë³µêµ¬
      state.votes=prev.votes; state.voting=prev.voting; state.requiredVotes=prev.requiredVotes; activateTab('seating');
      $('#candidates').value=prev.candidates; $('#studentList').value=prev.students; $('#cols').value=prev.cols; $('#rows').value=prev.rows; if($('#ytUrl')) $('#ytUrl').value=prev.ytUrl; state.score=prev.score; renderBallot(true); renderSeats(); renderScoreboard(); renderTeamEditor();
      console.groupEnd();
    }catch(err){ console.error('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜', err); }}

    // ë°”ì¸ë”©
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#year').textContent=new Date().getFullYear();
      try{ applyTheme(localStorage.getItem('easyban:dark')==='1'); }catch(e){}
      loadAll();
      normalizeScore();
      $$('.tab').forEach(btn=>btn.addEventListener('click',()=>activateTab(btn.dataset.tab)));
      $('#shuffleSeats').addEventListener('click', renderSeats);
      $('#clearSeats').addEventListener('click', ()=>{ $('#seatGrid').innerHTML=''; $('#seatCount').textContent=''; });
      $('#startVote').addEventListener('click', ()=>{ if(parseCandidates().length===0){ alert('í›„ë³´ì ëª…ë‹¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } const val=parseInt($('#requiredVotes').value||'0',10); state.requiredVotes=Number.isFinite(val)&&val>0?val:0; state.voting=true; $('#voteStatus').textContent='ì§„í–‰ ì¤‘(ë¹„ë°€íˆ¬í‘œ)'; renderBallot(true); updateVoteStatus(); });
      $('#endVote').addEventListener('click', ()=>endVoting());
      $('#resetVote').addEventListener('click', resetVote);
      renderBallot(true);
      $('#startNoise').addEventListener('click', ()=>startNoise().catch(err=>alert('ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: '+err)));
      $('#stopNoise').addEventListener('click', stopNoise);
      $('#previewNotice').addEventListener('click', previewNotice);
      $('#downloadNotice').addEventListener('click', downloadNotice);
      $('#clearNotice').addEventListener('click', ()=>{ $('#noticeText').value=''; previewNotice(); });

      // ì ìˆ˜íŒ ë°”ì¸ë”©
      if ($('#scoreReset')) $('#scoreReset').addEventListener('click', ()=>{ state.score.forEach(t=>t.score=0); renderScoreboard(); });
      if ($('#scoreAdd')) $('#scoreAdd').addEventListener('click', addTeam);
      if ($('#scoreRemove')) $('#scoreRemove').addEventListener('click', removeTeam);
      renderScoreboard();
      renderTeamEditor();

      // íƒ€ì´ë¨¸/ìŠ¤í†±ì›Œì¹˜ ë°”ì¸ë”©
      if($('#timerSet')) $('#timerSet').addEventListener('click', setTimerFromInput);
      if($('#timerStartPause')) $('#timerStartPause').addEventListener('click', function(){ state.tmr.running?pauseTimer():startTimer(); });
      if($('#timerReset')) $('#timerReset').addEventListener('click', resetTimer);
      if($('#timerInput')) $('#timerInput').addEventListener('keydown', function(e){ if(e.key==='Enter'){ setTimerFromInput(); }});
      if($('#swStartStop')) $('#swStartStop').addEventListener('click', function(){ state.sw.running?stopStopwatch():startStopwatch(); });
      if($('#swLap')) $('#swLap').addEventListener('click', lapStopwatch);
      if($('#swReset')) $('#swReset').addEventListener('click', resetStopwatch);
      renderTimerUI(); renderStopwatch();

      $('#darkToggle').addEventListener('click', ()=>applyTheme(!document.documentElement.classList.contains('dark')));
      $('#saveAll').addEventListener('click', saveAll);

      // í™•ëŒ€ ëª¨ë‹¬ ë°”ì¸ë”©
      var tz=$('#timerZoom'); if(tz) tz.addEventListener('click', function(){ openTimeModal('timer'); });
      var sz=$('#swZoom'); if(sz) sz.addEventListener('click', function(){ openTimeModal('sw'); });
      var tmc=$('#timeModalClose'); if(tmc) tmc.addEventListener('click', closeTimeModal);
      var tmb=$('#timeModalBackdrop'); if(tmb) tmb.addEventListener('click', closeTimeModal);

      renderSeats();
      previewNotice();
      if (localStorage.getItem('easyban:devtests')==='1') runDevTests();
    });

    window.addEventListener('beforeunload', stopNoise);
  </script>
</body>
</html>